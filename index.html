<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh·∫≠t k√Ω c·ªßa ƒê·∫≠u B·∫Øp</title>
    <!-- S·ª≠ d·ª•ng Tailwind CSS ƒë·ªÉ l√†m ƒë·∫πp giao di·ªán -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- S·ª≠ d·ª•ng font Inter t·ª´ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icon library -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .nav-button.active {
            background-color: #4a90e2;
            color: white;
        }
        .hidden-section, .hidden {
            display: none;
        }
        /* Hi·ªáu ·ª©ng loading */
        .is-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }
        .is-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
         .prose h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .prose ul {
            list-style: none;
            padding-left: 0;
        }
        .prose li {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        .prose li .icon {
            margin-right: 0.75rem;
            margin-top: 0.25rem;
            color: #3b82f6;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app-container" class="w-full max-w-4xl mx-auto p-4 min-h-screen">
        <!-- Header -->
        <header class="text-center my-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800">Nh·∫≠t k√Ω c·ªßa ƒê·∫≠u B·∫Øp üå±</h1>
            <p class="text-gray-500 mt-2">N∆°i l∆∞u gi·ªØ h√†nh tr√¨nh l·ªõn kh√¥n c·ªßa con</p>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center space-x-2 md:space-x-4 mb-8 bg-white p-2 rounded-xl shadow-md">
            <button data-target="developmentLogSection" class="nav-button active flex-1 md:flex-none flex items-center justify-center space-x-2 text-gray-600 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200 transition-all">
                <i data-lucide="book-heart"></i>
                <span>Nh·∫≠t k√Ω Ph√°t tri·ªÉn</span>
            </button>
            <button data-target="wonderWeeksSection" class="nav-button flex-1 md:flex-none flex items-center justify-center space-x-2 text-gray-600 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200 transition-all">
                <i data-lucide="brain-circuit"></i>
                <span>Tu·∫ßn Kh·ªßng Ho·∫£ng</span>
            </button>
            <button data-target="momentsSection" class="nav-button flex-1 md:flex-none flex items-center justify-center space-x-2 text-gray-600 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200 transition-all">
                <i data-lucide="camera"></i>
                <span>Kho·∫£nh kh·∫Øc</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main>
            <!-- 1. Development Log Section -->
            <section id="developmentLogSection">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Th√™m c·ªôt m·ªëc m·ªõi</h2>
                    <form id="logForm" class="space-y-4">
                        <input type="date" id="logDate" class="w-full p-3 border border-gray-300 rounded-lg" required>
                        <textarea id="logDescription" class="w-full h-28 p-3 border border-gray-300 rounded-lg" placeholder="H√¥m nay con ƒë√£ l√†m ƒë∆∞·ª£c g√¨? (Vd: L·∫ßn ƒë·∫ßu ti√™n con l·∫´y)" required></textarea>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all">L∆∞u c·ªôt m·ªëc</button>
                    </form>
                </div>
                <div class="mt-8">
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">C√°c c·ªôt m·ªëc c·ªßa con</h3>
                    <div id="logsContainer" class="space-y-4">
                        <p class="text-gray-500 text-center">Ch∆∞a c√≥ c·ªôt m·ªëc n√†o ƒë∆∞·ª£c ghi l·∫°i...</p>
                    </div>
                </div>
            </section>

            <!-- 2. Wonder Weeks Section -->
            <section id="wonderWeeksSection" class="hidden-section">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">D·ª± b√°o Tu·∫ßn Kh·ªßng Ho·∫£ng</h2>
                    <p class="text-gray-600 mb-4">Nh·∫≠p ng√†y sinh c·ªßa con ƒë·ªÉ xem d·ª± b√°o v·ªÅ tu·∫ßn ph√°t tri·ªÉn nh·∫£y v·ªçt s·∫Øp t·ªõi.</p>
                    <form id="wonderWeekForm" class="space-y-4">
                        <input type="date" id="birthDate" class="w-full p-3 border border-gray-300 rounded-lg" required>
                        <button id="wonderWeekBtn" type="submit" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700 transition-all">Xem d·ª± b√°o</button>
                    </form>
                </div>
                <div id="wonderWeekResult" class="mt-8 bg-white p-6 rounded-xl shadow-md hidden">
                    <!-- Wonder week result will be here -->
                </div>
            </section>

            <!-- 3. Moments Section -->
            <section id="momentsSection" class="hidden-section">
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Th√™m kho·∫£nh kh·∫Øc m·ªõi</h2>
                    <form id="momentForm" class="space-y-4">
                        <input type="text" id="momentTitle" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Ti√™u ƒë·ªÅ kho·∫£nh kh·∫Øc..." required>
                        <input type="file" id="momentImage" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
                        <p class="text-xs text-gray-500">L∆∞u √Ω: N√™n ch·ªçn ·∫£nh c√≥ dung l∆∞·ª£ng nh·ªè (d∆∞·ªõi 1MB) ƒë·ªÉ t·∫£i l√™n nhanh h∆°n.</p>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-all">L∆∞u kho·∫£nh kh·∫Øc</button>
                    </form>
                </div>
                <div class="mt-8">
                     <h3 class="text-2xl font-bold text-gray-700 mb-4">Album c·ªßa con</h3>
                    <div id="momentsContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                         <p class="text-gray-500 text-center col-span-full">Ch∆∞a c√≥ kho·∫£nh kh·∫Øc n√†o ƒë∆∞·ª£c l∆∞u...</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-12 mb-4">
            <p class="text-xs text-gray-400">M√£ ƒë·ªãnh danh c·ªßa b·∫°n (chia s·∫ª n·∫øu c·∫ßn): <span id="userIdDisplay" class="font-mono"></span></p>
        </footer>
    </div>
    
    <!-- Custom Modal -->
    <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
      <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
        <div class="mt-3 text-center">
          <h3 id="modalTitle" class="text-xl leading-6 font-bold text-gray-900"></h3>
          <div class="mt-2 px-7 py-3">
            <p id="modalMessage" class="text-sm text-gray-600"></p>
          </div>
          <div id="modalActions" class="items-center px-4 py-3 space-x-4">
            <button id="modalConfirmBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">X√°c nh·∫≠n</button>
            <button id="modalCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">H·ªßy</button>
          </div>
        </div>
      </div>
    </div>


    <script type="module">
        // --- B∆Ø·ªöC 1: C·∫§U H√åNH FIREBASE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // --- B∆Ø·ªöC 2: KH·ªûI T·∫†O FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, auth, db, userId;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("L·ªói kh·ªüi t·∫°o Firebase:", e);
            document.body.innerHTML = `<div class="text-center p-8 text-red-600">L·ªói nghi√™m tr·ªçng: Kh√¥ng th·ªÉ kh·ªüi t·∫°o Firebase. Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh.</div>`;
        }

        // --- B∆Ø·ªöC 3: X√ÅC TH·ª∞C NG∆Ø·ªúI D√ôNG ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('userIdDisplay').textContent = userId;
                loadDevelopmentLogs();
                loadMoments();
            } else {
                const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                try {
                    if (initialToken) {
                        await signInWithCustomToken(auth, initialToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("L·ªói ƒëƒÉng nh·∫≠p:", error);
                }
            }
        });

        // --- MODAL LOGIC ---
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        let confirmCallback = null;

        function showModal(title, message, onConfirmCallback = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmCallback = onConfirmCallback;

            if (onConfirmCallback) {
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.classList.add('hidden');
            }
            customModal.classList.remove('hidden');
        }

        function hideModal() {
            customModal.classList.add('hidden');
            confirmCallback = null;
        }

        modalConfirmBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            hideModal();
        });
        modalCancelBtn.addEventListener('click', hideModal);

        // --- GIAO DI·ªÜN V√Ä ƒêI·ªÄU H∆Ø·ªöNG ---
        const navButtons = document.querySelectorAll('.nav-button');
        const sections = document.querySelectorAll('main section');

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetId = button.dataset.target;
                sections.forEach(section => section.classList.add('hidden-section'));
                document.getElementById(targetId).classList.remove('hidden-section');
            });
        });
        
        lucide.createIcons();

        // --- T√çNH NƒÇNG 1: NH·∫¨T K√ù PH√ÅT TRI·ªÇN ---
        const logForm = document.getElementById('logForm');
        const logsContainer = document.getElementById('logsContainer');

        logForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('logDate').value;
            const description = document.getElementById('logDescription').value;
            
            if (!userId) { showModal("L·ªói", "Vui l√≤ng ch·ªù x√°c th·ª±c ng∆∞·ªùi d√πng."); return; }

            try {
                const logsCollection = collection(db, `artifacts/${appId}/users/${userId}/development_logs`);
                await addDoc(logsCollection, {
                    date: date,
                    description: description,
                    createdAt: serverTimestamp()
                });
                logForm.reset();
            } catch (error) {
                console.error("L·ªói khi th√™m c·ªôt m·ªëc:", error);
                showModal("L·ªói", "ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        });

        function loadDevelopmentLogs() {
            if (!userId) return;
            const logsCollection = collection(db, `artifacts/${appId}/users/${userId}/development_logs`);
            const q = query(logsCollection, orderBy("date", "desc"));

            onSnapshot(q, (snapshot) => {
                logsContainer.innerHTML = snapshot.empty ? `<p class="text-gray-500 text-center">Ch∆∞a c√≥ c·ªôt m·ªëc n√†o ƒë∆∞·ª£c ghi l·∫°i...</p>` : '';
                snapshot.forEach(docSnap => {
                    const log = docSnap.data();
                    const logEl = document.createElement('div');
                    logEl.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-start';
                    logEl.innerHTML = `
                        <div>
                            <p class="font-bold text-blue-700">${new Date(log.date).toLocaleDateString('vi-VN')}</p>
                            <p class="text-gray-600 mt-1">${log.description}</p>
                        </div>
                        <button data-id="${docSnap.id}" class="delete-log-btn text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    logsContainer.appendChild(logEl);
                });
                lucide.createIcons();
                document.querySelectorAll('.delete-log-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        showModal("X√°c nh·∫≠n x√≥a", "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c·ªôt m·ªëc n√†y?", async () => {
                            const docId = btn.dataset.id;
                            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/development_logs`, docId));
                        });
                    });
                });
            });
        }

        // --- T√çNH NƒÇNG 2: TU·∫¶N KH·ª¶NG HO·∫¢NG (OFFLINE) ---
        const wonderWeekForm = document.getElementById('wonderWeekForm');
        const wonderWeekResult = document.getElementById('wonderWeekResult');
        
        const wonderWeeksData = {
            5: {
                title: "Th·∫ø gi·ªõi c·ªßa nh·ªØng c·∫£m gi√°c thay ƒë·ªïi",
                signs: ["Qu·∫•y kh√≥c nhi·ªÅu h∆°n, ƒë√≤i b√∫ th∆∞·ªùng xuy√™n", "Ng·ªß √≠t h∆°n, gi·∫•c ng·ªß kh√¥ng s√¢u", "ƒê√≤i ƒë∆∞·ª£c √¥m ·∫•p, v·ªó v·ªÅ nhi·ªÅu h∆°n"],
                skills: ["B·∫Øt ƒë·∫ßu c√≥ n·ª• c∆∞·ªùi ch·ªß ƒë·ªông (social smile)", "T·ªânh t√°o v√† quan s√°t xung quanh nhi·ªÅu h∆°n", "Ph√°t ra nh·ªØng √¢m thanh g·ª´ g·ª´ ƒë·∫ßu ti√™n"],
                tips: ["TƒÉng c∆∞·ªùng √¥m ·∫•p, da ti·∫øp da", "N√≥i chuy·ªán v√† h√°t cho b√© nghe th∆∞·ªùng xuy√™n", "Cho b√© xem c√°c v·∫≠t c√≥ m√†u s·∫Øc t∆∞∆°ng ph·∫£n cao (ƒëen, tr·∫Øng)"]
            },
            8: {
                title: "Th·∫ø gi·ªõi c·ªßa c√°c quy lu·∫≠t",
                signs: ["B√°m m·∫π h∆°n, d·ªÖ gi·∫≠t m√¨nh", "T√¢m tr·∫°ng th·∫•t th∆∞·ªùng", "C√≥ th·ªÉ t·ª´ ch·ªëi b√∫ ho·∫∑c b√∫ v·∫∑t"],
                skills: ["B·∫Øt ƒë·∫ßu ki·ªÉm so√°t ƒë∆∞·ª£c ƒë·∫ßu v√† c·ªï t·ªët h∆°n", "Kh√°m ph√° tay v√† ch√¢n c·ªßa m√¨nh", "Ph√°t ra nhi·ªÅu √¢m thanh ƒëa d·∫°ng h∆°n"],
                tips: ["T·∫°o m·ªôt l·ªãch tr√¨nh sinh ho·∫°t ·ªïn ƒë·ªãnh", "Ch∆°i c√°c tr√≤ ch∆°i ƒë∆°n gi·∫£n nh∆∞ gi∆° ƒë·ªì v·∫≠t tr∆∞·ªõc m·∫∑t b√©", "Massage nh·∫π nh√†ng ƒë·ªÉ gi√∫p b√© th∆∞ gi√£n"]
            },
            12: {
                title: "Th·∫ø gi·ªõi c·ªßa nh·ªØng chuy·ªÉn ti·∫øp su√¥n s·∫ª",
                signs: ["√çt qu·∫•y kh√≥c h∆°n tu·∫ßn 8 nh∆∞ng v·∫´n c·∫ßn s·ª± ch√∫ √Ω", "Mu·ªën ƒë∆∞·ª£c 'tr√≤ chuy·ªán' nhi·ªÅu h∆°n", "Th√≠ch th√∫ v·ªõi c√°c chuy·ªÉn ƒë·ªông"],
                skills: ["B·∫Øt ƒë·∫ßu l·∫≠t t·ª´ ng·ª≠a sang nghi√™ng", "C·∫ßm n·∫Øm ƒë·ªì v·∫≠t m·ªôt c√°ch c√≥ ch·ªß ƒë√≠ch h∆°n", "Ph·∫£n ·ª©ng v·ªõi √¢m thanh b·∫±ng c√°ch quay ƒë·∫ßu"],
                tips: ["Cho b√© n·∫±m s·∫•p (tummy time) nhi·ªÅu h∆°n ƒë·ªÉ r√®n luy·ªán c∆° b·∫Øp", "ƒê∆∞a cho b√© c√°c ƒë·ªì ch∆°i an to√†n ƒë·ªÉ c·∫ßm n·∫Øm", "B·∫Øt ch∆∞·ªõc c√°c √¢m thanh c·ªßa b√© ƒë·ªÉ khuy·∫øn kh√≠ch giao ti·∫øp"]
            },
            19: {
                title: "Th·∫ø gi·ªõi c·ªßa c√°c s·ª± ki·ªán",
                signs: ["Kh·ªßng ho·∫£ng ng·ªß (ng·ªß ng√†y ng·∫Øn, ƒë√™m th·ª©c nhi·ªÅu)", "Bi·∫øng ƒÉn, d·ªÖ b·ªã ph√¢n t√¢m khi b√∫", "C√°u k·ªânh, kh√≥ ·ªü"],
                skills: ["B·∫Øt ƒë·∫ßu tr∆∞·ªùn ho·∫∑c l·∫≠t th√†nh th·∫°o", "Hi·ªÉu ƒë∆∞·ª£c chu·ªói s·ª± ki·ªán ƒë∆°n gi·∫£n (vd: th·∫•y m·∫π m·∫∑c √°o kho√°c l√† bi·∫øt s·∫Øp ƒëi ch∆°i)", "B·∫≠p b·∫π c√°c √¢m thanh ph·ª©c t·∫°p h∆°n"],
                tips: ["Ki√™n nh·∫´n v·ªõi gi·∫•c ng·ªß c·ªßa b√©, thi·∫øt l·∫≠p tr√¨nh t·ª± ƒëi ng·ªß", "Ch∆°i √∫ o√† ƒë·ªÉ gi√∫p b√© hi·ªÉu v·ªÅ s·ª± t·ªìn t·∫°i c·ªßa v·∫≠t th·ªÉ", "ƒê·ªçc s√°ch cho b√© nghe h√†ng ng√†y"]
            },
            26: {
                title: "Th·∫ø gi·ªõi c·ªßa c√°c m·ªëi quan h·ªá",
                signs: ["N·ªói s·ª£ ng∆∞·ªùi l·∫°, b√°m m·∫π ch·∫∑t h∆°n", "Th·ª©c d·∫≠y kh√≥c ƒë√™m, c·∫ßn m·∫π d·ªó d√†nh", "Th·ª≠ n√©m ƒë·ªì ƒÉn ho·∫∑c ƒë·ªì ch∆°i"],
                skills: ["B·∫Øt ƒë·∫ßu ng·ªìi v·ªØng kh√¥ng c·∫ßn tr·ª£ gi√∫p", "Chuy·ªÉn ƒë·ªì v·∫≠t t·ª´ tay n√†y sang tay kia", "Hi·ªÉu ƒë∆∞·ª£c kho·∫£ng c√°ch (xa, g·∫ßn)"],
                tips: ["T√¥n tr·ªçng n·ªói s·ª£ c·ªßa b√©, ƒë·ª´ng √©p b√© theo ng∆∞·ªùi l·∫°", "T·∫°o kh√¥ng gian an to√†n ƒë·ªÉ b√© t·∫≠p ng·ªìi v√† kh√°m ph√°", "G·ªçi t√™n c√°c ƒë·ªì v·∫≠t v√† h√†nh ƒë·ªông ƒë·ªÉ gi√∫p b√© x√¢y d·ª±ng m·ªëi li√™n h·ªá"]
            }
        };

        wonderWeekForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const birthDate = new Date(document.getElementById('birthDate').value);
            if (isNaN(birthDate.getTime())) {
                showModal("L·ªói", "Ng√†y sinh kh√¥ng h·ª£p l·ªá.");
                return;
            }

            const today = new Date();
            const ageInWeeks = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 7));

            const nextWonderWeekKey = Object.keys(wonderWeeksData).find(week => parseInt(week) >= ageInWeeks);

            wonderWeekResult.classList.remove('hidden');
            if (nextWonderWeekKey) {
                const data = wonderWeeksData[nextWonderWeekKey];
                let html = `
                    <p class="text-center text-gray-600 mb-4">B√© nh√† b·∫°n hi·ªán ƒë∆∞·ª£c <strong>${ageInWeeks}</strong> tu·∫ßn tu·ªïi. Tu·∫ßn kh·ªßng ho·∫£ng s·∫Øp t·ªõi l√†:</p>
                    <h2 class="text-2xl font-bold text-purple-700 text-center mb-2">Tu·∫ßn ${nextWonderWeekKey}: ${data.title}</h2>
                    <div class="prose max-w-none mt-6">
                        <h3><i class="icon" data-lucide="alert-circle"></i>D·∫•u hi·ªáu nh·∫≠n bi·∫øt</h3>
                        <ul>${data.signs.map(item => `<li><span class="icon"><i data-lucide="check-circle-2"></i></span><span>${item}</span></li>`).join('')}</ul>
                        <h3><i class="icon" data-lucide="sparkles"></i>K·ªπ nƒÉng m·ªõi</h3>
                        <ul>${data.skills.map(item => `<li><span class="icon"><i data-lucide="check-circle-2"></i></span><span>${item}</span></li>`).join('')}</ul>
                        <h3><i class="icon" data-lucide="heart-handshake"></i>G·ª£i √Ω cho ba m·∫π</h3>
                        <ul>${data.tips.map(item => `<li><span class="icon"><i data-lucide="check-circle-2"></i></span><span>${item}</span></li>`).join('')}</ul>
                    </div>
                `;
                wonderWeekResult.innerHTML = html;
            } else {
                wonderWeekResult.innerHTML = `<p class="text-center text-gray-600">B√© ƒë√£ l·ªõn v√† v∆∞·ª£t qua c√°c tu·∫ßn kh·ªßng ho·∫£ng ƒë·∫ßu ƒë·ªùi ƒë∆∞·ª£c l·∫≠p tr√¨nh s·∫µn trong ·ª©ng d·ª•ng. Ch√∫c m·ª´ng ba m·∫π v√† b√©!</p>`;
            }
            lucide.createIcons();
        });


        // --- T√çNH NƒÇNG 3: KHO·∫¢NH KH·∫ÆC ---
        const momentForm = document.getElementById('momentForm');
        const momentsContainer = document.getElementById('momentsContainer');
        
        momentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('momentTitle').value;
            const imageFile = document.getElementById('momentImage').files[0];

            if (!userId) { showModal("L·ªói", "Vui l√≤ng ch·ªù x√°c th·ª±c ng∆∞·ªùi d√πng."); return; }
            if (!imageFile) { showModal("Th√¥ng b√°o", "Vui l√≤ng ch·ªçn m·ªôt h√¨nh ·∫£nh."); return; }
            
            const reader = new FileReader();
            reader.readAsDataURL(imageFile);
            reader.onload = async () => {
                const imageData = reader.result;
                try {
                    const momentsCollection = collection(db, `artifacts/${appId}/users/${userId}/moments`);
                    await addDoc(momentsCollection, {
                        title: title,
                        imageData: imageData,
                        createdAt: serverTimestamp()
                    });
                    momentForm.reset();
                } catch (error) {
                    console.error("L·ªói khi l∆∞u kho·∫£nh kh·∫Øc:", error);
                    showModal("L·ªói", `ƒê√£ c√≥ l·ªói x·∫£y ra. C√≥ th·ªÉ do ·∫£nh qu√° l·ªõn. L·ªói: ${error.message}`);
                }
            };
            reader.onerror = (error) => {
                console.error("L·ªói ƒë·ªçc file:", error);
                showModal("L·ªói", "Kh√¥ng th·ªÉ ƒë·ªçc file ·∫£nh.");
            };
        });

        function loadMoments() {
            if (!userId) return;
            const momentsCollection = collection(db, `artifacts/${appId}/users/${userId}/moments`);
            const q = query(momentsCollection, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                momentsContainer.innerHTML = snapshot.empty ? `<p class="text-gray-500 text-center col-span-full">Ch∆∞a c√≥ kho·∫£nh kh·∫Øc n√†o ƒë∆∞·ª£c l∆∞u...</p>` : '';
                snapshot.forEach(docSnap => {
                    const moment = docSnap.data();
                    const momentEl = document.createElement('div');
                    momentEl.className = 'bg-white rounded-lg shadow-md overflow-hidden group relative';
                    momentEl.innerHTML = `
                        <img src="${moment.imageData}" alt="${moment.title}" class="w-full h-48 object-cover">
                        <div class="p-3">
                            <p class="font-semibold text-gray-700 truncate">${moment.title}</p>
                        </div>
                        <button data-id="${docSnap.id}" class="delete-moment-btn absolute top-2 right-2 bg-white/70 text-gray-700 p-2 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-500 hover:text-white transition-all">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    momentsContainer.appendChild(momentEl);
                });
                lucide.createIcons();
                document.querySelectorAll('.delete-moment-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        showModal("X√°c nh·∫≠n x√≥a", "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kho·∫£nh kh·∫Øc n√†y?", async () => {
                            const docId = btn.dataset.id;
                            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/moments`, docId));
                        });
                    });
                });
            });
        }
    </script>
</body>
</html>
